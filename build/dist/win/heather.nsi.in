; herschel.nsi
;
; This file is part of the herschel package 
;
; Copyright (c) 2009 Gregor Klinke
; All rights reserved.
;

;----------------------------------------------------------------------
; this is a simple herschel installer for windows.

;---------------------
;Include Modern UI

  !include "MUI.nsh"


;--------------------------------

; The name of the installer
Name "Herschel @VERSION@"

; The file to write
OutFile "herschel-@VERSION@-installer.exe"

; The default installation directory
InstallDir $PROGRAMFILES\Herschel-@VERSION@

; Registry key to check for directory (so if you install again, it will 
; overwrite the old one automatically)
InstallDirRegKey HKLM "Software\EyeStep_Herschel" "Install_Dir"

;--------------------------------
;Interface Settings

  !define MUI_ABORTWARNING

  !define MUI_FINISHPAGE_NOAUTOCLOSE
  !define MUI_UNFINISHPAGE_NOAUTOCLOSE
  !define MUI_COMPONENTSPAGE_SMALLDESC

  !insertmacro MUI_PAGE_WELCOME
  !insertmacro MUI_PAGE_LICENSE "@top_srcdir@\LICENSE"
  !insertmacro MUI_PAGE_COMPONENTS
  !insertmacro MUI_PAGE_DIRECTORY
  !insertmacro MUI_PAGE_INSTFILES
  !insertmacro MUI_PAGE_FINISH
  
  !insertmacro MUI_UNPAGE_WELCOME
  !insertmacro MUI_UNPAGE_CONFIRM
  !insertmacro MUI_UNPAGE_INSTFILES
  !insertmacro MUI_UNPAGE_FINISH


;--------------------------------

!ifndef NOINSTTYPES ; only if not defined
  InstType "Full"
  InstType "Core"
  ;InstType /NOCUSTOM
  InstType /COMPONENTSONLYONCUSTOM
!endif  


;--------------------------------
;Languages
 
  !insertmacro MUI_LANGUAGE "English"

;--------------------------------

; Pages

;Page components
;Page directory
;Page instfiles

;UninstPage uninstConfirm
;UninstPage instfiles

;--------------------------------

; The stuff to install
Section "Herschel (required)" sect_exe_id

  SectionIn 1 2 RO  ; full, core, Readonly
  
  ; Set output path to the installation directory.
  SetOutPath $INSTDIR
  
  ; Put file there
  File "@top_srcdir@\temp\dist-release\hrc.exe"
  File "@top_srcdir@\LICENSE"
  File "@top_srcdir@\BUGS"
  File "@top_srcdir@\NEWS"
  File "@top_srcdir@\README"
  
  ; Write the installation path into the registry
  WriteRegStr HKLM SOFTWARE\EyeStep_Herschel "Install_Dir" "$INSTDIR"
  
  ; Write the uninstall keys for Windows
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Herschel" "DisplayName" "EyeStep Herschel"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Herschel" "UninstallString" '"$INSTDIR\uninstall.exe"'
  WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Herschel" "NoModify" 1
  WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Herschel" "NoRepair" 1
  WriteUninstaller "uninstall.exe"
  
SectionEnd


; Section "Documentation" sect_docs_id
;   SectionIn 1 ; full
;   File "@top_srcdir@\doc\herschel.pdf"
; SectionEnd


; Optional section (can be disabled by the user)
Section "Start Menu Shortcuts" sect_menushorts_id
  SectionIn 1 ; full

  CreateDirectory "$SMPROGRAMS\Herschel @VERSION@"
  CreateShortCut "$SMPROGRAMS\Herschel @VERSION@\Uninstall.lnk" "$INSTDIR\uninstall.exe" "" "$INSTDIR\uninstall.exe" 0
  CreateShortCut "$SMPROGRAMS\Herschel @VERSION@\Herschel.lnk" "$INSTDIR\hrc.exe" "" "$INSTDIR\hrc.exe" 0

  IfFileExists $INSTDIR\herschel.pdf 0 +2
    CreateShortCut "$SMPROGRAMS\Herschel @VERSION@\Herschel.pdf.lnk" "$INSTDIR\herschel.pdf" "" "$INSTDIR\herschel.pdf" 0
  
SectionEnd


;--------------------------------
;Descriptions

  ;Language strings
  LangString DESC_herschel ${LANG_ENGLISH} "The herschel compiler and core files"
  LangString DESC_menu_shortcuts ${LANG_ENGLISH} "Add folder and shortcuts to the windows menu."
  LangString DESC_herschel_docs ${LANG_ENGLISH} "Installs the manual."


  ;Assign language strings to sections
  !insertmacro MUI_FUNCTION_DESCRIPTION_BEGIN
    !insertmacro MUI_DESCRIPTION_TEXT ${sect_exe_id} $(DESC_herschel)
    !insertmacro MUI_DESCRIPTION_TEXT ${sect_menushorts_id} $(DESC_menu_shortcuts)
;    !insertmacro MUI_DESCRIPTION_TEXT ${sect_docs_id} $(DESC_herschel_docs)
  !insertmacro MUI_FUNCTION_DESCRIPTION_END



;--------------------------------

Function .onInit
  SectionSetInstTypes ${sect_exe_id} 3
  SectionSetInstTypes ${sect_menushorts_id} 3
;  SectionSetInstTypes ${sect_docs_id} 1
FunctionEnd


;--------------------------------

; Uninstaller

Section "Uninstall"
  
  ; Remove registry keys
  DeleteRegKey /ifempty HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Herschel"
  DeleteRegKey /ifempty HKLM SOFTWARE\EyeStep_Herschel

  ; Remove files and uninstaller
  Delete $INSTDIR\hrc.exe
  Delete $INSTDIR\LICENSE
  Delete $INSTDIR\BUGS
  Delete $INSTDIR\README
  Delete $INSTDIR\NEWS
  Delete $INSTDIR\herschel.pdf
  Delete $INSTDIR\uninstall.exe

  ; Remove shortcuts, if any
  Delete "$SMPROGRAMS\Herschel @VERSION@\*.*"

  ; Remove directories used
  RMDir "$SMPROGRAMS\Herschel @VERSION@"
  RMDir "$INSTDIR"

SectionEnd
